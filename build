#! /bin/bash

installPrefix=/usr

if [ `uname -o` == "Solaris" ]; then
  echo SOLARIS
  pkgin update
  crle -l /usr/local/lib -u
  ln -s -f /usr/local/bin/firesight /opt/local/bin/firesight
  installPrefix=/usr/local
  if [ "$(type -p install-sh)" == "" ]; then
    echo "++++++++++++++++++ INSTALLING INSTALL-SH ++++++++++++"
    pkgin -y install install-sh
  else
    echo INSTALL-SH OK
  fi
fi

if [ "$(type -p gcc)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING GCC ++++++++++++"
  pkgin -y install scmgit-base gcc47
else
  echo GCC OK
fi

if [ "$(type -p cmake)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING CMAKE ++++++++++++"
  if [ `uname -o` == "Solaris" ]; then
    pkgin -y install gmake
    pkgin -y install cmake
  else
    apt-get -y install cmake
  fi
else
  echo CMAKE OK
fi

if [ "$(type -p libtool)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING LIBTOOL ++++++++++++"
  pkgin -y install libtool
else
  echo LIBTOOL OK
fi

if [ "$(type -p aclocal)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING AUTOMAKE ++++++++++++"
  pkgin -y install automake
else
  echo AUTOMAKE OK
fi

if [ ! -e /usr/local/include/jansson.h ] ; then
  echo "++++++++++++++++++ INSTALLING JANNSON C LIBRARY ++++++++++++"
  if [ `uname -o` == "Solaris" ]; then
    pkgin -y install autoconf
  else 
    apt-get -y install dh-autoreconf
  fi
  git clone git://github.com/akheron/jansson jannson
  pushd jannson
  autoreconf -i
  ./configure
  cmake .
  make install
  popd
fi

if [ ! -e /usr/lib/libopencv_features2d.so ] && [ ! -e /usr/local/lib/libopencv_features2d.so ] ; then
  echo "++++++++++++++++++ INSTALLING OPENCV C++ LIBRARIES ++++++++++++"
  if [ `uname -o` == "Solaris" ]; then
  #  pkgin -y install opencv
    if [ ! -e opencv ] ; then
      git clone https://github.com/firepick1/opencv -b 2.4
    fi
    mkdir opencv/build
    pushd opencv/build
      cmake \
        -D CMAKE_BUILD_TYPE=DEBUG \
	-D CMAKE_INSTALL_PREFIX=/usr/local \
        ..
      make install
    popd
  else
    apt-get -y install libopencv-dev
  fi
fi

if [ -e CMakeFiles ] ; then 
  echo removing existing makefiles
  rm -rf CMakeCache.txt CMakeFiles CMakeFiles.txt target cmake_install.cmake CPackConfig.cmake CPackSourceConfig.cmake
  if [ "$SUDO_USER" == "" ] ; then
    mkdir target
  else 
    sudo -u $SUDO_USER mkdir target
  fi
fi


echo creating makefiles
if [ "$SUDO_USER" == "" ]; then
  cmake -DCMAKE_INSTALL_PREFIX:PATH=$installPrefix "$@" .
else
  sudo -u $SUDO_USER cmake -DCMAKE_INSTALL_PREFIX:PATH=$installPrefix "$@" .
fi
echo building and installing FireSight...
make install

echo HAPPINESS AND JOY...
