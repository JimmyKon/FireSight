#! /bin/bash

if [ "$SUDO_USER" == "" ]; then
  echo "This script must be run with sudo command from a non-root user"
  exit -1
fi

installPrefix=/usr

if [ `uname -o` == "Solaris" ]; then
  echo SOLARIS
  pkgin update
  crle -l /usr/local/lib -u
  ln -s -f /usr/local/bin/firesight /opt/local/bin/firesight
  installPrefix=/usr/local
  if [ "$(type -p install-sh)" == "" ]; then
    echo "++++++++++++++++++ INSTALLING INSTALL-SH ++++++++++++"
    pkgin -y install install-sh
  else
    echo INSTALL-SH OK
  fi
fi

if [ "$(type -p gcc)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING GCC ++++++++++++"
  pkgin -y install scmgit-base gcc47
else
  echo GCC OK
fi

if [ "$(type -p cmake)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING CMAKE ++++++++++++"
  if [ `uname -o` == "Solaris" ]; then
    pkgin -y install gmake
    pkgin -y install cmake
  else
    apt-get -y install cmake
  fi
else
  echo CMAKE OK
fi

if [ "$(type -p libtool)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING LIBTOOL ++++++++++++"
  pkgin -y install libtool
else
  echo LIBTOOL OK
fi

if [ "$(type -p aclocal)" == "" ]; then
  echo "++++++++++++++++++ INSTALLING AUTOMAKE ++++++++++++"
  pkgin -y install automake
else
  echo AUTOMAKE OK
fi

if [ ! -e /usr/local/include/jansson.h ] ; then
  echo "++++++++++++++++++ INSTALLING JANNSON C LIBRARY ++++++++++++"
  if [ `uname -o` == "Solaris" ]; then
    pkgin -y install autoconf
  else 
    apt-get -y install dh-autoreconf
  fi
  git clone git://github.com/akheron/jansson jannson
  pushd jannson
  autoreconf -i
  ./configure
  cmake .
  make install
  popd
fi

if [ -e /usr/lib/libopencv_core.so ]; then
  echo "OpenCV found in /usr/lib:"
  ls /usr/lib/libopencv_core.so.*
elif [ -e /usr/local/lib/libopencv_core.so ]; then
  echo "OpenCV found in /usr/local/lib:"
  ls /usr/local/lib/libopencv_core.so.*
else
  echo "++++++++++++++++++ INSTALLING OPENCV C++ LIBRARIES ++++++++++++"
  #if [ `uname -o` == "Solaris" ]; then
  #  pkgin -y install opencv
    if [ "$(type -p apt-get)" == "" ] || [ `uname -o` == "Solaris" ]; then
      echo "apt-get: UNAVAILABLE"
    else
      echo "apt-get: Installing openexr for libIlmImf.so.6"
      apt-get -y install openexr
      apt-get -y install libavcodec-dev
      apt-get -y install libavformat-dev
      apt-get -y install libswscale-dev
      apt-get -y install libdc1394-22
      apt-get -y install libz-dev
    fi

    if [ ! -e opencv ] ; then
      git clone https://github.com/firepick1/opencv -b 2.4
    fi
    mkdir opencv/build
    pushd opencv/build
      cmake \
	-D WITH_OPENEXR=OFF \
        -D CMAKE_BUILD_TYPE=DEBUG \
	-D CMAKE_INSTALL_PREFIX=/usr/local \
        ..
      make install
    popd
  #else
  #  apt-get -y install libopencv-dev
  #fi
fi

if [ -e CMakeFiles ] ; then 
  echo removing existing makefiles
  rm -rf CMakeCache.txt CMakeFiles CMakeFiles.txt target cmake_install.cmake CPackConfig.cmake CPackSourceConfig.cmake
  if [ "$SUDO_USER" == "" ] ; then
    mkdir target
  else 
    sudo -u $SUDO_USER mkdir target
  fi
fi


echo creating makefile
sudo -u $SUDO_USER cmake \
  -DCMAKE_INSTALL_PREFIX:PATH=$installPrefix "$@" \
  .
echo building and installing FireSight...
make install
if [ $? -eq 0 ]; then
  echo HAPPINESS AND JOY...
else
  echo SADNESS AND TEARS...
fi
